<template id="addlayertemplate">
  <div>
  <div id="rasters">
    <div>Add a raster layer (with API key if needed):</div>
    Code <input type="text" size="10" id="rastercode">
    API <input type="text" size="10" id="api">
    <button id="addraster">Add</button>
  </div>
  <div id="vectors">
    Add vector file<br>
    Name/identifier <input type="text" size="10" id="vectorname">
    Url <input type="text" size="50" id="vectorfile">
    MongoDB? <input type="checkbox" id="mongodb" value="mongodb">
    <button id="addvector">Add</button>
  </div>
  </div>
</template>

<script type="module">
  var utils = require('utils');
  var $ = utils.$;
  var olMap = require('olMap');
  var map = olMap.get();
  $('addlayer').style.display = 'none';
  // make sure toolbar initialised
  var toolbar = require('components/toolbar');
  // add addlayertemplate to toolbar
  toolbar.appendChild(utils.importTemplate('addlayer'));
  var mapDef = require('mapDef').get();
  var rasters = require('rasters');
  var vectors = require('vectors');

  $('addraster').addEventListener('click', function() {
    var code = $('rastercode').value;
    System.import('sources/' + code)
    .then(function(m) {
      var options;
      // use apikey if entered
      if ($('api').value) {
        options = {rasters: []};
        var raster = {};
        raster[code] = $('api').value;
        options.rasters.push(raster);
      }
      rasters.add([m], options);
      mapDef.rasters = mapDef.rasters || [];
      mapDef.rasters.push(code);
      var bound = rasters.changeLayer.bind(map);
      bound(m.getLayers()[0].getProperties().id);
    });
  });

  $('addvector').addEventListener('click', function() {
    var url = $('vectorfile').value;
    var option = {
      url: url,
      id: $('vectorname').value || url,
      add: true
    };
    if ($('mongodb').checked === true) {
      option.type = 'mongodb';
    }
    vectors.add({vectors: [option]});
    if (rasters.getLayers().getLength() == 0) {
      olMap.use4326View();
    }
    delete(option.add);
    mapDef.vectors = mapDef.vectors || [];
    mapDef.vectors.push(option);
  });
</script>
