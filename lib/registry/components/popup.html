<template id="popuptemplate">
  <div id="popup" style="background-color: white"></div>
</template>

<script type="module">
  var utils = require('utils');
  var $ = utils.$;
  // make sure toolbar initialised
  var toolbar = require('components/toolbar');
  // add popuptemplate to toolbar
  toolbar.appendChild(utils.importTemplate('popup'));
var ol = require('ol');
var map = require('olMap').get();
var vectors = require('vectors');

// create sphere for Haversine distance calculation below
var wgs84Sphere = new ol.Sphere(6378137);

var overlay = new ol.Overlay({
  element: $('popup'),
  positioning: 'bottom-center',
  stopEvent: true
});

// add featureOverlay if not present
vectors.addHighlightOverlay();

// click on feature displays attributes in overlay
map.on('singleclick', function(evt) {
  // uses overlay and highlightOverlay as closure
  map.highlightOverlay.getFeatures().clear();
  var html = '', savedFeature;
  map.forEachFeatureAtPixel(evt.pixel, function(feature, layer) {
    if (feature != savedFeature) {
    if (html !== '') {
      // if >1 feature, displays all in one box
      html += '<br>';
    }
    html += 'Id: '	+ feature.getId();
    var atts = feature.getProperties();
    for (var att in atts) {
      if (att != 'geometry') {
        html += '<br>' + att + ': ' + atts[att];
      }
    }
    var geom = feature.getGeometry().clone();
    if (geom.getLength) {
      // get length for linestrings
      var projCode = map.getView().getProjection().getCode();
      if (projCode != 'EPSG:4326' && projCode != 'EPSG:3857') {
        // no point in projected plane length for these projections
        html += '<br>length (projected plane): ' + Math.round(geom.getLength() * 0.1) / 100 + 'km';
      }
      // Haversine calculation needs 4326 coords
      geom.transform(projCode, 'EPSG:4326');
      var coords = geom.getCoordinates();
      var length = 0.0;
      for (var i = 1; i < coords.length; i++) {
        length += wgs84Sphere.haversineDistance(coords[i-1], coords[i]);
      }
      html += '<br>length (Haversine): ' + Math.round(length * 0.1) / 100 + 'km';
    }
    map.highlightOverlay.addFeature(feature);
    savedFeature = feature;
    }
  }, null, function(l) {
    // use only vector layers
    return ol.layer.Vector && l instanceof ol.layer.Vector;
  });

  var el = overlay.getElement();
  if (html !== '') {
    el.innerHTML = html;
    el.style.display = 'block';
    overlay.setPosition(evt.coordinate);
  } else {
    el.innerHTML = '';
    el.style.display = 'none';
  }
});
map.addOverlay(overlay);

var mapDef = require('mapDef').get();
mapDef.components = mapDef.components || {};
mapDef.components.popup = true;
</script>
