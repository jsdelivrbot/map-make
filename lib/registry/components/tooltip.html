<template id="tooltiptemplate">
  <div id="tooltip" style="background-color: white; position: absolute; z-index: 20000"></div>
</template>

<script type="module">
  var utils = require('utils');
  var $ = utils.$;
  // make sure toolbar initialised
  var toolbar = require('components/toolbar');
  // add tooltiptemplate to toolbar
  toolbar.appendChild(document.importNode($('tooltiplink').import
      .getElementById('tooltiptemplate').content, true));
var ol = require('ol');
var olMap = require('olMap');
var map = olMap.get();

// add featureOverlay if not present
olMap.addHighlightOverlay();

var highlightedFeature;

/**
 * with canvas, vectors have no separate identity, so have to use mousemove
 * with map.forEachFeatureAtPixel() to establish whether there is a feature at the
 * new mouse position. If so, make the tooltip div visible with title attribute
 */
map.getViewport().onmousemove = function(evt) {
  var pixel = map.getEventPixel(evt);
  // if >1 feature at same pixel, e.g. points on top of polygon, uses last
  var feature = map.forEachFeatureAtPixel(pixel, function(feature, layer) {
    return feature;
  }, null, function(l) {
    // use only vector layers
    return ol.layer.Vector && l instanceof ol.layer.Vector;
  });
  var tooltip = $('tooltip');
  var html;
  if (feature) {
    html = feature.getProperties().name || feature.getProperties().title;
  }
  if (html) {
    tooltip.innerHTML = html;
    tooltip.style.left = (pixel[0] + 10) + 'px';
    tooltip.style.top = (pixel[1] + 10) + 'px';
    tooltip.style.display = 'block';
    // change cursor to indicate to users that they can click on this point
    map.getTarget().style.cursor = 'pointer';
  } else {
    tooltip.style.display = 'none';
    map.getTarget().style.cursor = '';
  }
  if (feature !== highlightedFeature) {
    if (highlightedFeature) {
      map.highlightOverlay.removeFeature(highlightedFeature);
    }
    if (feature) {
      map.highlightOverlay.addFeature(feature);
    }
    highlightedFeature = feature;
  }
};
</script>
