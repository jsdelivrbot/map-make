<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>OL3 Map-make</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ol3/3.4.0/ol.min.css">
  <!--<link rel="stylesheet" href="../modular-ol3/dist/olCustom.css">-->
  <script>
    // load Promises polyfill if not natively supported
    if (!window.Promise) {
      document.write(
        '<' + 'script src="https://es6-promises.s3.amazonaws.com/es6-promise-2.0.1.min.js"><\/script>'
      );
    }
  </script>
  <!--load module loader polyfill and system.js extensions-->
  <script src="https://jspm.io/system.js"></script>
</head>
<body>
  <!--<div id="map" style="height: 400px"></div>-->

  <script>
    (function() {
      // set paths specific to localhost
      System.baseURL = System.baseURL + 'lib/';
      // override setting in jspm's system.js
      System.paths['*'] = '*.js';
      // only needed for fetching plugins; included in jspm's system.js
      // System.paths.jspm = "https://registry.jspm.io/*.js";
      // System.paths.github = 'https://github.jspm.io/*.js';
      System.paths.ol = '../../ol3/build/ol.js';
      // System.paths.ol = 'https://cdnjs.cloudflare.com/ajax/libs/ol3/3.4.0/ol.min.js';//../../gulpclosure/build/ol.js';

      System.import('map-make').catch(function(err) {
        console.log(err);
        alert('Error reading map-make.js');
        return;
      });
    })();
  </script>
  <!--<div id="mapDef" style="display:none">https://github.jspm.io/probins/map-make-samples/mapDefs/cataloniaVectors.json</div>-->
  <div id="toolbar">
    <div id="layerswitcher" style="display: none">
      <div>Layer Switcher</div>
    </div>
    <div id="rasters">
      <div>Add a raster layer:</div>
      Code <input type="text" size="10" id="rastercode">
      <button id="addraster">Add</button>
    </div>
    <div id="vectors">
      Add vector file<br>
      Name/identifier <input type="text" size="10" id="vectorname">
      Url <input type="text" size="50" id="vectorfile">
      MongoDB? <input type="checkbox" id="mongodb" value="mongodb">
      <button id="addvector">Add</button>
    </div>
    <div id="widgets">
      <div>Add widgets:</div>
      <button id="adddraw">Draw</button>
    </div>
    <div id="serial" style="display: none">
      <button id="serialise">Serialise drawn features</button>
      <textarea name="Text1" cols="40" rows="5" id="serialOP"></textarea>
    </div>
  </div>
  <script>
    document.getElementById('addraster').addEventListener('click', function() {
      var olMap = System.get('olMap').default;
      System.import('registry/sources/' + document.getElementById('rastercode').value)
      .then(function(m) {
        olMap.addRasters([m]);
      });
    });
    document.getElementById('addvector').addEventListener('click', function() {
      var olMap = System.get('olMap').default;
      var url = document.getElementById('vectorfile').value;
      var option = {
        url: url,
        id: document.getElementById('vectorname').value || url
      };
      if (document.getElementById('mongodb').checked === true) {
        option.type = 'mongodb';
      }
      olMap.addVectors([option]);
  // FIXME only if not already present
      olMap.addFeaturesListener();
    });
    var fo;
    document.getElementById('adddraw').addEventListener('click', function() {
      var map = System.get('olMap').default.get();
      fo = new ol.FeatureOverlay({map: map});
      var draw; // global so we can remove it later
      // function addInteraction() {
      var value = 'LineString';
      if (value !== 'None') {
        draw = new ol.interaction.Draw({
          features: fo.getFeatures(),
          type: value
        });
        map.addInteraction(draw);
      }
      document.getElementById('serial').style.display = 'block';
// }
    });
    document.getElementById('serialise').addEventListener('click', function() {
      var map = System.get('olMap').default.get();
      var gj = new ol.format.GeoJSON();
      document.getElementById('serialOP').value =
          gj.writeFeatures(fo.getFeatures().getArray(),{featureProjection:'EPSG:3857'});
    });
  </script>
</body>
</html>